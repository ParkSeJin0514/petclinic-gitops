apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: petclinic
resources:
  - ../../base
  - cluster-secret-store.yaml
  - external-secret.yaml
  - backend-config.yaml
  - monitoring-ingress.yaml
  # cluster-monitoring Ingress (kube-prometheus-stack용)
  - cluster-monitoring-backend-config.yaml
  - cluster-monitoring-ingress.yaml
patches:
  - path: service-patch.yaml
  # petclinic-ingress를 GCE Ingress로 변환 (Static IP 사용)
  - path: petclinic-ingress-patch.yaml
  # grafana-ingress, prometheus-ingress 삭제 (앱 모니터링은 monitoring-ingress.yaml로 대체)
  - target:
      kind: Ingress
      name: grafana-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: grafana-ingress
  - target:
      kind: Ingress
      name: prometheus-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: prometheus-ingress
  # cluster-grafana-ingress 삭제 (cluster-monitoring-ingress.yaml로 통합)
  - target:
      kind: Ingress
      name: cluster-grafana-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: cluster-grafana-ingress
  # cluster-prometheus-ingress 삭제 (cluster-monitoring-ingress.yaml로 통합)
  - target:
      kind: Ingress
      name: cluster-prometheus-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: cluster-prometheus-ingress
  # cluster-alertmanager-ingress 삭제 (LB 연결 불필요)
  - target:
      kind: Ingress
      name: cluster-alertmanager-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: cluster-alertmanager-ingress
images:
  - name: springcommunity/spring-petclinic-config-server
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-config-server
    newTag: "25"
  - name: springcommunity/spring-petclinic-discovery-server
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-discovery-server
    newTag: "30"
  - name: springcommunity/spring-petclinic-customers-service
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-customers-service
    newTag: "30"
  - name: springcommunity/spring-petclinic-visits-service
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-visits-service
    newTag: "30"
  - name: springcommunity/spring-petclinic-vets-service
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-vets-service
    newTag: "30"
  - name: springcommunity/spring-petclinic-api-gateway
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-api-gateway
    newTag: "74"
  - name: springcommunity/spring-petclinic-admin-server
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-admin-server
    newTag: "30"
