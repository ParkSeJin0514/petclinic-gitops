apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: petclinic
resources:
  - ../../base
  - cluster-secret-store.yaml
  - external-secret.yaml
  - backend-config.yaml
  - monitoring-ingress.yaml
  - cluster-monitoring-backend-config.yaml
patches:
  - path: petclinic-ingress-patch.yaml
  - path: service-patch.yaml
  # grafana-ingress, prometheus-ingress 삭제 (앱 모니터링은 monitoring-ingress.yaml로 대체)
  - target:
      kind: Ingress
      name: grafana-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: grafana-ingress
  - target:
      kind: Ingress
      name: prometheus-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: prometheus-ingress
  # cluster-*-ingress: ALB → GKE Ingress로 패치 (JSON Patch로 annotations 완전 대체)
  - target:
      kind: Ingress
      name: cluster-grafana-ingress
    patch: |-
      - op: replace
        path: /metadata/annotations
        value:
          kubernetes.io/ingress.class: gce
          cloud.google.com/backend-config: '{"default": "grafana-cluster-backend-config"}'
      - op: replace
        path: /spec/ingressClassName
        value: gce
      - op: replace
        path: /metadata/namespace
        value: petclinic
      - op: replace
        path: /spec/rules/0/http/paths/0/backend/service/name
        value: grafana-server
      - op: replace
        path: /spec/rules/0/http/paths/0/backend/service/port/number
        value: 3000
  - target:
      kind: Ingress
      name: cluster-prometheus-ingress
    patch: |-
      - op: replace
        path: /metadata/annotations
        value:
          kubernetes.io/ingress.class: gce
          cloud.google.com/backend-config: '{"default": "prometheus-cluster-backend-config"}'
      - op: replace
        path: /spec/ingressClassName
        value: gce
      - op: replace
        path: /metadata/namespace
        value: petclinic
      - op: replace
        path: /spec/rules/0/http/paths/0/backend/service/name
        value: prometheus-server
  # cluster-alertmanager-ingress 삭제 (LB 연결 불필요)
  - target:
      kind: Ingress
      name: cluster-alertmanager-ingress
    patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: cluster-alertmanager-ingress
images:
  - name: springcommunity/spring-petclinic-config-server
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-config-server
    newTag: "16"
  - name: springcommunity/spring-petclinic-discovery-server
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-discovery-server
    newTag: "16"
  - name: springcommunity/spring-petclinic-customers-service
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-customers-service
    newTag: "16"
  - name: springcommunity/spring-petclinic-visits-service
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-visits-service
    newTag: "16"
  - name: springcommunity/spring-petclinic-vets-service
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-vets-service
    newTag: "16"
  - name: springcommunity/spring-petclinic-api-gateway
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-api-gateway
    newTag: "26"
  - name: springcommunity/spring-petclinic-admin-server
    newName: asia-northeast3-docker.pkg.dev/kdt2-final-project-t1/petclinic-msa/petclinic-admin-server
    newTag: "16"
