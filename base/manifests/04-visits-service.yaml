---
# ============================================================================
# Visits Service Deployment
# ============================================================================
# Spring Boot ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ - ë°©ë¬¸ ê¸°ë¡ ê´€ë¦¬
# - MySQL Database í•„ìš”
# - Eureka Discovery Serverì— ë“±ë¡
# - Config Serverì—ì„œ ì„¤ì • ë¡œë“œ
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: visits-service
  namespace: petclinic
  labels:
    app: visits-service
    tier: business
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: visits-service
  template:
    metadata:
      labels:
        app: visits-service
        tier: business
        version: v1
    spec:
      containers:
        - name: visits-service
          image: springcommunity/spring-petclinic-visits-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8082
              protocol: TCP
          
          # Resource Limits (Java ì• í”Œë¦¬ì¼€ì´ì…˜ ìµœì í™”)
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 768Mi

          # Health Checks (ë¶€í•˜ ì‹œ íƒ€ì„ì•„ì›ƒ ë°©ì§€ë¥¼ ìœ„í•´ ì—¬ìœ ìˆê²Œ ì„¤ì •)
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 200
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 20

          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8082
            initialDelaySeconds: 120
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 10
          
          # Environment Variables
          env:
            # JVM ë©”ëª¨ë¦¬ ì„¤ì • (ì»¨í…Œì´ë„ˆ limitì˜ 70%)
            - name: JAVA_OPTS
              value: "-Xmx512m -Xms256m"

            # Spring Profile
            - name: SPRING_PROFILES_ACTIVE
              value: "kubernetes,mysql"

            # Server Port (ê°•ì œ ê³ ì • - ì¤‘ìš”!)
            - name: SERVER_PORT
              value: "8082"
            
            # Config Server (ì²« ë²ˆì§¸ ìš°ì„ ìˆœìœ„)
            - name: CONFIG_SERVER_URL
              value: "http://config-server:8888"
            
            # ğŸ”¥ Eureka ì„¤ì •ì„ JSONìœ¼ë¡œ ê°•ì œ ì ìš©
            - name: SPRING_APPLICATION_JSON
              value: |
                {
                  "eureka": {
                    "instance": {
                      "preferIpAddress": true
                    },
                    "client": {
                      "serviceUrl": {
                        "defaultZone": "http://discovery-server:8761/eureka/"
                      }
                    }
                  }
                }
            
            # Database Configuration (Secretì—ì„œ ë¡œë“œ)
            - name: SPRING_DATASOURCE_URL
              valueFrom:
                secretKeyRef:
                  name: petclinic-db-secret
                  key: SPRING_DATASOURCE_URL
            
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: petclinic-db-secret
                  key: SPRING_DATASOURCE_USERNAME
            
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: petclinic-db-secret
                  key: SPRING_DATASOURCE_PASSWORD
            
            # JPA/Hibernate ì„¤ì •
            - name: SPRING_JPA_HIBERNATE_DDL_AUTO
              value: "update"
            
            - name: SPRING_JPA_SHOW_SQL
              value: "false"
            
            # Connection Pool ì„¤ì •
            - name: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
              value: "10"
            
            - name: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
              value: "5"

---
# ============================================================================
# Visits Service
# ============================================================================
apiVersion: v1
kind: Service
metadata:
  name: visits-service
  namespace: petclinic
  labels:
    app: visits-service
    tier: business
spec:
  selector:
    app: visits-service
  ports:
    - name: http
      port: 8082
      targetPort: 8082
      protocol: TCP
  type: ClusterIP
